<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tcb.vru_service.dao.AlarmDao">

    <resultMap id="dataAlarmDOResultMap" type="com.tcb.vru_service.pojo.DataAlarmDO">
        <id property="alarmId" column="alarm_id" jdbcType="BIGINT"/>
        <result property="alarmCode" column="alarm_code" jdbcType="VARCHAR"/>
        <result property="institutionCode" column="institution_code" jdbcType="VARCHAR"/>
        <result property="deviceCode" column="device_code" jdbcType="VARCHAR"/>
        <result property="alarmInfo" column="alarm_info" jdbcType="VARCHAR"/>
        <result property="alarmAction" column="alarm_action" jdbcType="VARCHAR"/>
        <result property="actionUser" column="action_user" jdbcType="VARCHAR"/>
        <result property="alarmStatus" column="alarm_status" jdbcType="VARCHAR"/>
        <result property="alarmTime" column="alarm_time" jdbcType="TIMESTAMP"/>
        <result property="actionTime" column="action_time" jdbcType="TIMESTAMP"/>
        <result property="sendFlag" column="send_flag" jdbcType="TINYINT"/>
        <result property="thingCode" column="thing_code" jdbcType="VARCHAR"/>
        <result property="minValue" column="min_value" jdbcType="DOUBLE"/>
        <result property="maxValue" column="max_value" jdbcType="DOUBLE"/>
        <result property="thingValue" column="thing_value" jdbcType="DOUBLE"/>
        <result property="levelNo" column="level_no" jdbcType="INTEGER"/>
        <result property="dataTime" column="data_time" jdbcType="TIMESTAMP"/>
        <result property="planId" column="plan_id" jdbcType="INTEGER"/>
        <result property="updateTime" column="update_time" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="dataAlarmMap" type="com.tcb.vru_service.model.DataAlarmVO">
        <result column="institution_name" property="institution" jdbcType="VARCHAR"/>
        <result column="device_name" property="deviceName" jdbcType="VARCHAR"/>
        <result column="institution_address" property="institutionAddress" jdbcType="VARCHAR"/>
        <result column="dictionary_name" property="alarmName" jdbcType="VARCHAR"/>
        <result column="level_name" property="levelName" jdbcType="VARCHAR"/>
        <result column="alarm_info" property="alarmInfo" jdbcType="VARCHAR"/>
        <result column="alarm_time" property="alarmTime" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="alarmDictionaryMap" type="java.util.Map">
        <result column="dictionary_code" property="value" jdbcType="VARCHAR"/>
        <result column="dictionary_name" property="label" jdbcType="VARCHAR"/>
    </resultMap>

    <resultMap id="alarmRankMap" type="java.util.Map">
        <result column="device_name" property="deviceName" jdbcType="VARCHAR"/>
        <result column="device_code" property="deviceCode" jdbcType="VARCHAR"/>
        <result column="times" property="alarmTimes" javaType="INTEGER"/>
    </resultMap>
    
    <resultMap id="getAlarmStatistic" type="java.util.Map">
        <result column="alarm_time_format" property="alarmTime" jdbcType="VARCHAR"/>
        <result column="alarm_count" property="alarmCount" javaType="INTEGER"/>
    </resultMap>

    <select id="getAlarmDictionary" resultMap="alarmDictionaryMap">
        SELECT
        dictionary_code,
        dictionary_name
        FROM
        util_dictionary ud
        WHERE ud.dictionary_type = "alarm_code"
    </select>

    <!-- 查询报警设置个数 -->
    <select id="getAlarmDataCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM data_alarm da
        <if test="dataAlarmDO != null">
            <where>
                <if test="dataAlarmDO.levelNo != null">
                    AND da.level_no = #{dataAlarmDO.levelNo}
                </if>
                <if test="dataAlarmDo.institutionCode != null">
                    AND da.institution_code = #{dataAlarmDO.institutionCode}
                </if>
                <if test="dataAlarmDO.deviceCode != null and dataAlarmDO.deviceCode != ''">
                    AND da.device_code = #{dataAlarmDO.deviceCode}
                </if>
                <if test="dataAlarmDO.alarmCode != null and dataAlarmDO.alarmCode != ''">
                    AND da.alarm_code = #{dataAlarmDO.alarmCode}
                </if>
                <if test="dataAlarmDO.beginTime != null and dataAlarmDO.endTime != null">
                    AND alarm_time BETWEEN #{dataAlarmDO.beginTime} AND #{dataAlarmDO.endTime}
                </if>
            </where>
        </if>
    </select>

    <select id="alarmRank" resultMap="alarmRankMap">
        SELECT
          device_name,
          da.device_code,
          COUNT( * ) AS times
        FROM
          data_alarm da
	      LEFT JOIN vru_core.base_device bd ON da.device_code = bd.device_code
        WHERE
          da.level_no = #{levelNo}
          AND alarm_time BETWEEN #{beginTime}
          AND #{endTime}
          AND da.device_code IN
        <foreach collection="deviceCodes" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
          da.device_code
        ORDER BY
          times DESC
          LIMIT 0,
          10
    </select>

    <!-- 查询报警设置数据 -->
    <select id="getAlarmShowData" resultMap="dataAlarmMap">
        SELECT
        institution_name,
        device_name,
        institution_address,
        dictionary_name,
        level_name,
        alarm_info,
        alarm_time
        FROM data_alarm da
        LEFT JOIN vru_core.alarm_level AS al ON da.level_no = al.level_no
        LEFT JOIN vru_core.base_device AS bd ON da.device_code = bd.device_code
        LEFT JOIN vru_core.base_institution AS bi ON bd.institution_id = bi.institution_id
        LEFT JOIN vru_core.util_dictionary AS ud ON da.alarm_code = ud.dictionary_code
        <if test="dataAlarmDO != null">
            <where>
                <if test="dataAlarmDO.deviceCode != null and dataAlarmDO.deviceCode != ''">
                    AND da.device_code = #{dataAlarmDO.deviceCode}
                </if>
                <if test="dataAlarmDO.alarmCode != null and dataAlarmDO.alarmCode != ''">
                    AND da.alarm_code = #{dataAlarmDO.alarmCode}
                </if>
                <if test="dataAlarmDO.beginTime != null and dataAlarmDO.endTime != null">
                    AND alarm_time BETWEEN #{dataAlarmDO.beginTime} AND #{dataAlarmDO.endTime}
                </if>
            </where>
            <if test="dataAlarmDO.rowIndex != null and dataAlarmDO.rowCount != null">
                LIMIT #{dataAlarmDO.rowIndex}, #{dataAlarmDO.rowCount}
            </if>
        </if>
    </select>
    
    <select id="getAlarmCodeCount" resultType="java.lang.Integer">
        SELECT
        COUNT(*)
        FROM
        data_alarm
        WHERE alarm_code = #{alarmCode}
        AND level_no = #{levelNo}
        AND alarm_time BETWEEN #{beginTime} AND #{endTime}
        AND device_code IN
        <foreach collection="deviceCodes" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>
    
    <select id="getAlarmStatistic" resultMap="getAlarmStatistic">
        SELECT
	      DATE_FORMAT(alarm_time,'%Y-%m-%d') AS alarm_time_format,
          COUNT(*) AS alarm_count
        FROM
	      data_alarm
        WHERE
          alarm_time BETWEEN #{beginTime}
	      AND #{endTime}
	      AND level_no = #{levelNo}
          AND device_code = #{deviceCode}
          <if test="alarmCode != null">
              AND alarm_code = #{alarmCode}
          </if>
        GROUP BY alarm_time_format
    </select>

    <!-- 获取条件范围内报警预警个数 -->
    <select id="getWithinAlarmCount" resultType="java.lang.Integer">
        SELECT COUNT(alarm_id)
        FROM data_alarm
        WHERE alarm_time BETWEEN #{beginTime} AND #{endTime}
        AND institution_code = #{institutionCode}
        <if test="levelNo != null">
            AND level_no = #{levelNo}
        </if>
        <if test="alarmCode != null and alarmCode != ''">
            AND alarm_code = #{alarmCode}
        </if>
    </select>

    <!-- 获取报警数据 -->
    <select id="listAlarm" resultMap="dataAlarmDOResultMap">
        SELECT DISTINCT
            alarm_id,
            alarm_code,
            institution_code,
            device_code,
            alarm_info,
            alarm_action,
            action_user,
            alarm_status,
            alarm_time,
            action_time,
            send_flag,
            thing_code,
            min_value,
            max_value,
            thing_value,
            level_no,
            data_time,
            plan_id,
            update_time
        FROM data_alarm
        <where>
            alarm_time BETWEEN #{beginTime} AND #{endTime}
            <if test="institutionCodeList != null and institutionCodeList.size()>0">
                AND institution_code IN
                <foreach collection="institutionCodeList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="deviceCodeList != null and deviceCodeList.size()>0">
                AND device_code IN
                <foreach collection="deviceCodeList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="alarmCodeList != null and alarmCodeList.size()>0">
                AND alarm_code IN
                <foreach collection="alarmCodeList" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="levelNo != null">
                AND level_no = #{levelNo}
            </if>
        </where>
    </select>

</mapper>